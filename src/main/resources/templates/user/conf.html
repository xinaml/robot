<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<html>
<head>
    <meta charset="utf-8">
    <title>参数配置</title>
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.1.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="../bootstrap/css/bootstrap-table.min.css"/>
    <link rel="stylesheet" href="../bootstrap/css/bootstrap-datetimepicker.min.css">
    <link rel="stylesheet" href="../toastr/toastr.min.css">
    <script src="../js/jquery-3.2.1.min.js"></script>
    <script src="../bootstrap/js/bootstrap.js"></script>
    <script src="../bootstrap/js/bootstrap-table.min.js"></script>
    <script src="../bootstrap/js/bootstrap-table-zh-CN.js"></script>
    <script src="../bootstrap/js/bootstrap-datetimepicker.min.js"></script>
    <script src="../bootstrap/js/bootstrap-datetimepicker.zh-CN.js"></script>
    <script src="../toastr/toastr.min.js"></script>
    <script src="../js/common/common.js"></script>

</head>
<body>
<nav class="navbar navbar-expand-sm bg-light">
    <ul class="navbar-nav">
        <li class="nav-item">
            <a class="nav-link" href="/">首页</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="/order/page">待卖出订单</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="/socket/page">日志</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="/user/conf">用户配置</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="/user/page">用户</a>
        </li>
    </ul>
</nav>

<div style="margin-top: 20px;float: left;width: 500px" class="container mt-3">
    <div>
        <form id="userFrom">
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text">账号</span>
                </div>
                <input type="hidden" name="id" id="userId" >
                <input type="text" class="form-control" placeholder="passPhrase" name="passPhrase" id="passPhrase">
            </div>
            <br>
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text">secretKey</span>
                </div>
                <input type="text" class="form-control" placeholder="secretKey" id="secretKey" name="secretKey">
            </div>
            <br>
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text">apiKey</span>
                </div>
                <input type="text" class="form-control" placeholder="apiKey" name="apiKey" id="apiKey">
            </div>
            <br>
        </form>
    </div>

    <br>
    <div>
        <button type="submit" class="btn btn-primary" id="edit_user_btn" onclick="editUserSecret()">保存设置</button>
    </div>

    <br>

</div>

<div style="margin-top: 20px;float: left;width: 500px;margin-left: 100px" class="container mt-3">
    <form id="confFrom">
        <div class="input-group">
            <div class="input-group-prepend">
                <span class="input-group-text">k线粒度</span>
            </div>
            <select class="form-control" name="time" id="time">
                <option value="1分钟">1分钟</option>
                <option value="3分钟">3分钟</option>
                <option value="5分钟">5分钟</option>
                <option value="15分钟">15分钟</option>
                <option value="30分钟">30分钟</option>
                <option value="1小时">1小时</option>
                <option value="2小时">2小时</option>
                <option value="4小时">4小时</option>
                <option value="6小时">6小时</option>
                <option value="12小时">12小时</option>
                <option value="1天">1天</option>
                <option value="1周">1周</option>
            </select>
        </div>
        <br>
        <div class="input-group">
            <div class="input-group-prepend">
                <span class="input-group-text">挂单等待时间</span>
            </div>
            <input type="text" class="form-control" placeholder="挂单等待时间" id="orderTime" name="orderTime"
                   onkeyup="value=value.replace(/^(0+)|[^\d]+/g,'')">
            <span class="input-group-text">分钟</span>
        </div>
        <br>
        <div class="input-group">
            <div class="input-group-prepend">
                <span class="input-group-text">卖出等待时间</span>
            </div>
            <input type="text" class="form-control" placeholder="等待卖出时间" id="sellTime" name="sellTime"
                   onkeyup="value=value.replace(/^(0+)|[^\d]+/g,'')">
            <span class="input-group-text">分钟</span>
        </div>
        <br>
        <div class="input-group">
            <div class="input-group-prepend">
                <span class="input-group-text">合约币种</span>
            </div>
            <select class="form-control" name="type" id="type">
                <option value="BTC-USD">BTC-USD</option>
                <option value="EOS-USD">EOS-USD</option>
                <option value="LTC">LTC-USD</option>
            </select>
        </div>
        <br>
        <div class="input-group">
            <div class="input-group-prepend">
                <span class="input-group-text">合约id</span>
            </div>
            <input type="text" class="form-control" placeholder="合约id" id="contract" name="contract" >
        </div>
        <br>
        <div class="input-group">
            <div class="input-group-prepend">
                <span class="input-group-text">保留金额</span>
            </div>
            <input type="text" class="form-control" placeholder="保留金额" id="account" name="account"
                   onkeyup="if(isNaN(value))execCommand('undo')" onafterpaste="if(isNaN(value))execCommand('undo')">
        </div>
        <br>
        <div class="input-group">
            <div class="input-group-prepend">
                <span class="input-group-text">杠杆倍数</span>
            </div>
            <input type="text" class="form-control" placeholder="杠杆倍数" id="leverage" name="leverage"
                   onkeyup="value=value.replace(/^(0+)|[^\d]+/g,'')">
        </div>
        <br>
        <div class="input-group">
            <div class="input-group-prepend">
                <span class="input-group-text">开张数</span>
        </div>
            <input type="text" class="form-control" placeholder="开张数" id="count" name="count"
                   onkeyup="value=value.replace(/^(0+)|[^\d]+/g,'')">
        </div>
        <br>
        <div class="input-group">
            <div class="input-group-prepend">
                <span class="input-group-text">买入价倍率</span>
            </div>
            <input type="text" class="form-control" placeholder="买入价倍率" name="buyMultiple" id="buyMultiple"
                   onkeyup="if(isNaN(value))execCommand('undo')" onafterpaste="if(isNaN(value))execCommand('undo')">
        </div>
        <br>

        <div class="input-group">
            <div class="input-group-prepend">
                <span class="input-group-text">卖出价倍率</span>
            </div>
            <input type="text" class="form-control" placeholder="卖出价倍率" name="selfMultiple" id="selfMultiple"
                   onkeyup="if(isNaN(value))execCommand('undo')" onafterpaste="if(isNaN(value))execCommand('undo')">
        </div>
        <br>
        <div class="input-group">
            <div class="input-group-prepend">
                <span class="input-group-text">亏损多少卖出</span>
            </div>
            <input type="text" class="form-control" placeholder="亏损多少卖出" name="loss" id="loss"
                   onkeyup="if(isNaN(value))execCommand('undo')" onafterpaste="if(isNaN(value))execCommand('undo')">
            <span class="input-group-text">%</span>  &nbsp;<p style="color: gray">如：亏损-50%卖出,填50</p>
        </div>
        <br>
        <div class="input-group">
            <span class="input-group-text">只等待卖出</span>&nbsp;<p style="color: gray">不买入，仅卖出。</p>
                <input id="onlySell" name="onlySell" value="true" type="checkbox" onchange="changeOnly()"  style="margin-left: 10px;width: 40px;height:40px">
        </div>

    </form>
    <br>
    <div>
        <button type="submit" class="btn btn-primary" id="edit_btn" onclick="editConf()">保存配置</button>
    </div>

    <br>
    <div>
        <button class="btn btn-default" id="a_stop" onclick="stop()">开启自动交易</button>
    </div>
</div>

</body>
<script>
    //加载数据
    $(function () {
        $.ajax({
            type: 'GET',
            url: '/user/conf/get',
            dataType: 'json',
            cache: false,//false是不缓存，true为缓存
            async: true,//true为异步，false为同步
            success: function (rs) {
                if (rs.code == 0) {
                    if (rs.data != null) {
                        $("#time").find("option:contains('" + rs.data.time + "')").attr("selected", true);
                        $("#account").val(rs.data.account)
                        $("#count").val(rs.data.count)
                        $("#contract").val(rs.data.contract)
                        $("#type").find("option:contains('" + rs.data.type + "')").attr("selected", true);
                        $("#buyMultiple").val(rs.data.buyMultiple)
                        $("#selfMultiple").val(rs.data.selfMultiple)
                        $("#leverage").val(rs.data.leverage)
                        $("#orderTime").val(rs.data.orderTime)
                        $("#sellTime").val(rs.data.sellTime)
                        $("#onlySell").attr('checked',rs.data.onlySell)
                        $("#onlySell").val(rs.data.onlySell)
                        $("#loss").val(rs.data.loss)

                    }
                } else {
                    toastr.error(rs.msg);
                }
            }
        })

        $.ajax({
            type: 'GET',
            url: '/user/info',
            dataType: 'json',
            cache: false,//false是不缓存，true为缓存
            async: true,//true为异步，false为同步
            success: function (rs) {
                if (rs.code == 0) {
                    var data = (rs.data.stop == true ? "开启自动交易" : "关闭自动交易");
                    $("#a_stop").text(data)
                    $("#passPhrase").val(rs.data.passPhrase)
                    $("#secretKey").val(rs.data.secretKey)
                    $("#apiKey").val(rs.data.apiKey)
                    $("#userId").val(rs.data.id)
                } else {
                    toastr.error(rs.msg);
                }
            }
        })
    });
    //编辑Secret key
    function editUserSecret() {
        var data = $('#userFrom').serialize();
        var submitData = decodeURIComponent(data, true);
        $.ajax({
            type: 'PUT',
            url: '/user/edit/secret',
            data: submitData,
            dataType: 'json',
            cache: false,//false是不缓存，true为缓存
            async: true,//true为异步，false为同步
            success: function (rs) {
                if (rs.code == 0) {
                    toastr.success(rs.msg);
                } else {
                    toastr.error(rs.msg);
                }
            }
        })

    }
    function editConf() {
        var data = $('#confFrom').serialize();
        var submitData = decodeURIComponent(data, true);
        $.ajax({
            type: 'PUT',
            url: '/user/conf/edit',
            data: submitData,
            dataType: 'json',
            cache: false,//false是不缓存，true为缓存
            async: true,//true为异步，false为同步
            success: function (rs) {
                if (rs.code == 0) {
                    toastr.success(rs.msg);
                } else {
                    toastr.error(rs.msg);
                }
            }
        })

    }

    function stop() {
        $.ajax({
            type: 'POST',
            url: '/user/stop',
            dataType: 'json',
            cache: false,//false是不缓存，true为缓存
            async: true,//true为异步，false为同步
            success: function (rs) {
                if (rs.code == 0) {
                    var data = (rs.data == true ? "开启自动交易" : "关闭自动交易");
                    $("#a_stop").text(data)
                } else {
                    toastr.error(rs.msg);
                }
            }
        })
    }
    function changeOnly() {
        var a =  $("#onlySell").prop('checked');
        if(a==true){
            $("#onlySell").val('true')
        }else {
            $("#onlySell").val('false')
        }
    }
</script>

</html>